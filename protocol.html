<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fraise: Fraise Protocol (v2.1.2)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-Fraise.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Fraise
   &#160;<span id="projectnumber">2.1</span>
   </div>
   <div id="projectbrief">FRAmework for Interfacing Software and Electronics</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('protocol.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Fraise Protocol (v2.1.2) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Fraise</b> is a half-duplex asynchronous serial communication protocol.</p>
<p>Up to 126 devices (called <b>fruits</b>) can be connected to the master controller (which is called <b>pied</b>), via a common bus. <br  />
 The master controller is connected to a computer, usually via USB.</p>
<p>The bitrate of the Fraise bus is currently fixed to <b>250 kbits/sec</b>.</p>
<p>Communication is based on [1 start bit + 9 bits + 1 stop bit] words; if bit 9 is set, the 8 lower bits represent an address byte, or ID, which is used to select one of the <b>fruits</b>. <br  />
 ID must be between 1 and 126. ID 127 is reserved for future use. <br  />
 Words with bit 9 cleared are data bytes, which are read by the addressed <b>fruit</b>.</p>
<p>Transfers occur by packets of up to 31 effective data bytes. <br  />
 Packets can be of two types: raw bytes or characters string.</p>
<p>Each <b>fruit</b> stores an <b>ID</b> (8 bit) and a <b>NAME</b> (max 16 char string) in eeprom. Devices connected to the same bus are not allowed to share the same ID or NAME.</p>
<p>In order to be renamed, a <b>fruit</b> should be connected alone to the bus. <br  />
 For any other operation, all <b>fruits</b> can be connected together to the bus.</p>
<p>A <b>fruit</b> is assigned to an ID using its NAME to address it. The NAME of a <b>fruit</b> is also used in bootloader mode, for flashing a new application firmware.</p>
<p>Normal communications use ID to access the <b>fruit</b>.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Pied-to-fruit communication</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
normal output</h2>
<p>The <b>pied</b> initiates transmission by sending the <b>fruit</b> ID byte with bit 9 on, followed by a length byte where bit 8 is set if the packet is a string packet. <br  />
 The message continues with the data bytes, then ends with a checksum byte. <br  />
 The <b>fruit</b> acknowledges the packet by sending a null byte.</p>
<p>(in this chapter, # means next character has bit 9 set)</p>
<div class="fragment"><div class="line">packet: #NLD(...)DS</div>
<div class="line">- #N = fruit ID + bit9</div>
<div class="line">- L = 128 * c + l:  c (bit8) = packet is character string, l = number of following data bytes (31 max).</div>
<div class="line">- D(...)D = l data bytes.</div>
<div class="line">- S = -sum (modulo 256) of all bytes before S (N+L+D+...+D).</div>
</div><!-- fragment --><p><b>Fruit</b> number N must acknowledge the packet returning <code>0</code> in less than 1 millisecond, or returns <code>1</code> to signal a checksum error.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
broadcast output</h2>
<p>If ID is 0, all the <b>fruits</b> decode the packet; no <b>fruit</b> has to acknowledge.</p>
<p>Special broadcast commands are provided to assign an ID to a <b>fruit</b>, or to establish a 8 bits communication for bootloader purpose. <br  />
 The first data byte is the broadcast command:</p>
<ul>
<li><code>’I’</code> = all reInit</li>
<li><code>’F’ + NAME</code> = tell the <b>fruit</b> called NAME to switch to bootloader. Note: the <b>fruit</b> also boots in bootloader mode, and jumps to application after 1 second or as soon as it receives a byte with bit 9 set.</li>
<li><code>’N’ + ID + NAME</code> = assign ID (1 to 127) to <b>fruit</b> NAME; here ID is written in hexadecimal ascii e.g: "N0AFruit" -&gt; <b>fruit</b> named "Fruit" is given ID = 10.</li>
<li><code>’B’</code> = broadcast string</li>
<li><code>’b’</code> = broadcast raw bytes</li>
</ul>
<p>'B' and 'b' broadcast messages can be used by the user application (e.g to send a global clock).</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Fruit-to-pied communication</h1>
<p><b>Fruits</b> are polled sequentially, between transmissions of pied-to-fruits packets. <br  />
 The <b>pied</b> initiates transmission: the first byte is the ID of tested <b>fruit</b>, with bit 9 set to signal the start of the packet, and bit 8 set to signal a poll message. <br  />
 Then ID + 128 is repeated with bit 9 cleared, in order to secure addressing. <br  />
 If the <b>fruit</b> has nothing to transmit, it returns a null byte. Otherwise it sends a packet, which is acknowledged by the <b>pied</b>.</p>
<p>(# means next character has bit 9 set)</p>
<h2><a class="anchor" id="autotoc_md5"></a>
polling for input</h2>
<div class="fragment"><div class="line">packet: #MM</div>
<div class="line">- #M = fruit ID + bit8(128) + bit9</div>
<div class="line">-  M = fruit ID + bit8(128)</div>
</div><!-- fragment --><p><b>Fruit</b> number ID must answer before 1 ms.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
fruit answer</h2>
<div class="fragment"><div class="line">packet: LD(...)DS</div>
<div class="line">- L = 128 * c + l: c (bit8) = packet is character string, l = number of following data bytes (31 max).</div>
<div class="line">- D(...)D = l data bytes.</div>
<div class="line">- S = -sum (modulo 256) of all bytes before S (L + D + ... + D).</div>
</div><!-- fragment --><p>The <b>pied</b> then returns <code>0</code> to acknowledge the packet, or <code>1</code> to signal a checksum error.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
fruit "nothing to report" answer</h2>
<div class="fragment"><div class="line">packet: 0 (one null byte)</div>
</div><!-- fragment --><p>No checksum byte in this case; the <b>pied</b> does not have to acknowledge.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Bootloader communication</h1>
<p>Bit 9 is always cleared. <br  />
 Bootloader packets start with the number of following bytes (length byte). <br  />
 The last byte is the checksum (the sum of all bytes including length and checksum, modulo 256, must be zero). <br  />
 The first byte after the length byte indicates the command:</p>
<ul>
<li><code>’R’</code> = rename command: message must be "RENAME:" + NAME; <b>fruit</b> answers <code>’R’</code>.</li>
<li><code>’V’ + NAME</code> = verify that we are talking to the bootloader of the <b>fruit</b> called NAME; the <b>fruit</b> must answer <code>’V’</code> (additionnaly, the <b>fruit</b> now locks in bootloader mode).</li>
<li><code>’:’</code> = first character of an hexfile line; at the end of the line, the <b>fruit</b> answers:<ul>
<li><code>’X’</code> to acknowledge the line,</li>
<li><code>’Y’</code> if the end of the hexfile has been successfully reached,</li>
<li><code>’z’</code> for bad line checksum error,</li>
<li><code>’u’</code> for unsupportded hex command, or</li>
<li><code>’l’</code> for bad hex line format.</li>
</ul>
</li>
<li><code>’A’</code> = goto Application (quit bootloader).</li>
</ul>
<p>After 100ms without receiving anything from the <b>pied</b>, the <b>fruit</b> discards waiting received bytes, and next received byte will start a new line.</p>
<p>The <b>fruit</b> initially boots in bootloader mode; bootloader switches to application:</p><ul>
<li>when it receives a ’A’</li>
<li>or when it receives an non-zero address byte (bit 9 on)</li>
<li>or 1 second after power-up if it has not been verified.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md10"></a>
Fraise USB Protocol</h1>
<p>The <b>pied</b> is connected to the host computer via USB.</p>
<p>(here * means byte has bit 9 set)</p>
<h2><a class="anchor" id="autotoc_md11"></a>
output to fruit</h2>
<p>The host sends an addressed message to the <b>pied</b>, which forward it to the <b>fruit</b>.</p>
<p><code>"0100\n" -&gt; *0x01 0x01 0x00 0xFE</code>: send 0 to <b>fruit</b> ID 1. <br  />
 <code>"81Hi\n" -&gt; *0x01 0x82 0x48 0x69 0xCC</code>: send "Hi" to <b>fruit</b> ID 1.</p>
<p>The <b>pied</b> reports errors to the host:</p>
<ul>
<li><code>"sTnn\n"</code> if <b>fruit</b> nn didn’t answer (timeout)</li>
<li><code>"sann\n"</code> if the <b>fruit</b> refused to acknowledge the packet (packet error or buffer full).</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
broadcast output</h2>
<p>The host can ask the <b>pied</b> to send a message to all the <b>fruits</b>:</p>
<p><code>"!BI\n" -&gt; *0x00 0x82 0x42 0x49 0xF3</code>: send "I" to all <b>fruits</b> ("string" message). <br  />
 <code>"!b00\n" -&gt; *0x00 0x01 0x00 0xFF</code>: send 0 to all <b>fruits</b> ("raw bytes" message).</p>
<h2><a class="anchor" id="autotoc_md13"></a>
polling for input</h2>
<p>The host can enable or not the active polling of each fruit.</p>
<p><code>"#S04\n"</code>: start polling <b>fruit</b> ID 4 <br  />
 <code>"#C04\n"</code>: stop polling <b>fruit</b> ID 4</p>
<p>When <b>fruit</b> nn answers for the first time, the <b>pied</b> sends to USB: <code>"sCnn\n"</code> (meaning: <b>fruit</b> nn is now connected). When <b>fruit</b> nn stops answering, the <b>pied</b> sends to USB: <code>"scnn\n"</code>.</p>
<p>If the <b>pied</b> received a corrupted packet from <b>fruit</b> nn (checksum error), it signals this error by <code>"sxnn\n"</code>.</p>
<p>When the <b>pied</b> successfully receives a packet from <b>fruit</b> nn, it forwards it to host prefixed with "NN", where NN equals to nn, plus 0x80 if the message is a character string.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
control</h2>
<p><code>"!N04Fruit1\n"</code>: assign ID 04 to fruit called "Fruit1". <br  />
 <code>"#i\n"</code>: reinit the <b>pied</b> (clears polling for all <b>fruits</b>). <br  />
 <code>"#V\n"</code>: query the firmware version of the <b>pied</b>, which answers (currently) <code>"#V UsbFraise 2.1.6 (SpareTimeLabs/SDCC) A.Rousseau 2023\n"</code> <br  />
 <code>"#R\n"</code>: query the piedID (usually 1), the <b>pied</b> answers <code>"#ID01\n"</code> <br  />
 <code>"#UNLOCK\n"</code>: allow setting the piedID (which must be the next command) <br  />
 <code>"#W02\n"</code>: set the piedID to 2</p>
<p>The piedID allows to distinguish several pieds connected to several USB ports.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
bootloader mode</h2>
<p><code>"!FFruit1\n"</code>: ask "Fruit1" to jump to bootloader.</p>
<p>Additionnaly, the <b>pied</b> switches to bootloading mode: <br  />
 it forwards directly every line (’<br  />
’ terminated, must not begin with "#" or "!") from the host to the bus, then listens to the bus for any answer from the <b>fruit</b>, and puts this answer back to host, adding the 'b' character at the beginning of each line.</p>
<p>Example messages to bootloader:</p>
<p><code>"RENAME:Fruit1\n"</code>: rename "Fruit1" ALL (!!!) connected <b>fruits</b> being in bootloader mode (that's why a single <b>fruit</b> should be connected before doing this). <br  />
 <code>"A\n"</code>: ask the <b>fruit</b> to run Application (quit bootloader mode) <br  />
</p>
<p>Quit bootloading mode:</p>
<p><code>"#F\n"</code>: ask the <b>pied</b> to quit bootloading mode</p>
<h2><a class="anchor" id="autotoc_md16"></a>
logging</h2>
<p>The <b>pied</b> can send informational messages to the USB host, for debugging purpose. Each log line if prefixed with the 'l' character.</p>
<hr  />
<p> <em>Antoine Rousseau - metalu.net 2013-2023</em></p>
<p>LICENSE: CC-BY-ND <br  />
 This document is placed under the terms of the Creative Commons Attribution-NoDerivatives 4.0 International Public License <br  />
 <a href="http://creativecommons.org/licenses/by-nd/4.0/legalcode">http://creativecommons.org/licenses/by-nd/4.0/legalcode</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Feb 6 2024 16:46:41 for Fraise by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
